"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[9944],{5390:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>c,contentTitle:()=>o,default:()=>g,frontMatter:()=>d,metadata:()=>a,toc:()=>s});var r=t(5893),i=t(1151);const d={},o="\u96c6\u6210\u5f00\u53d1",a={id:"mobile/binderceptor/sdk",title:"\u96c6\u6210\u5f00\u53d1",description:"\u261e Github \u261c\u3000\u3000\u261e Gitee \u261c",source:"@site/docs/mobile/binderceptor/sdk.md",sourceDirName:"mobile/binderceptor",slug:"/mobile/binderceptor/sdk",permalink:"/docs/mobile/binderceptor/sdk",draft:!1,unlisted:!1,editUrl:"https://github.com/iofomo/fomosite/blob/main/website/docs/mobile/binderceptor/sdk.md",tags:[],version:"current",frontMatter:{},sidebar:"binderceptor",previous:{title:"Binderceptor",permalink:"/docs/mobile/binderceptor/Introduce"}},c={},s=[{value:"\u73af\u5883\u914d\u7f6e",id:"\u73af\u5883\u914d\u7f6e",level:3},{value:"\u57fa\u7840\u73af\u5883",id:"\u57fa\u7840\u73af\u5883",level:4},{value:"\u5e93\u4f9d\u8d56",id:"\u5e93\u4f9d\u8d56",level:4},{value:"\u65e5\u5fd7\u6253\u5370",id:"\u65e5\u5fd7\u6253\u5370",level:3},{value:"Simple\u65e5\u5fd7",id:"simple\u65e5\u5fd7",level:4},{value:"Transaction_Data\u65e5\u5fd7\uff1a",id:"transaction_data\u65e5\u5fd7",level:4},{value:"Write_Read\u65e5\u5fd7\uff1a",id:"write_read\u65e5\u5fd7",level:4},{value:"\u53c2\u6570\u8fc7\u6ee4",id:"\u53c2\u6570\u8fc7\u6ee4",level:3},{value:"\u6570\u636e\u4fee\u6539",id:"\u6570\u636e\u4fee\u6539",level:3},{value:"\u8c03\u7528\u62e6\u622a",id:"\u8c03\u7528\u62e6\u622a",level:3}];function l(e){const n={a:"a",blockquote:"blockquote",code:"code",h1:"h1",h3:"h3",h4:"h4",li:"li",p:"p",pre:"pre",ul:"ul",...(0,i.a)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.h1,{id:"\u96c6\u6210\u5f00\u53d1",children:"\u96c6\u6210\u5f00\u53d1"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.a,{href:"https://www.github.com/iofomo/binderceptor",children:"\u261e Github \u261c"}),"\u3000\u3000",(0,r.jsx)(n.a,{href:"https://www.gitee.com/iofomo/binderceptor",children:"\u261e Gitee \u261c"})]}),"\n",(0,r.jsx)(n.h3,{id:"\u73af\u5883\u914d\u7f6e",children:"\u73af\u5883\u914d\u7f6e"}),"\n",(0,r.jsx)(n.h4,{id:"\u57fa\u7840\u73af\u5883",children:"\u57fa\u7840\u73af\u5883"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"Android Studio\uff1a"}),"4.2"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"Gradle\uff1a"}),"6.9.2"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"NDK\uff1a"}),"21.4.7075529"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"Python\uff1a"}),"2.7.x/3.x"]}),"\n"]}),"\n",(0,r.jsx)(n.h4,{id:"\u5e93\u4f9d\u8d56",children:"\u5e93\u4f9d\u8d56"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-groovy",children:"dependencies {\n    implementation (name: 'cmpt-mts-binderceptor', ext: 'aar')\n}\n"})}),"\n",(0,r.jsx)(n.h3,{id:"\u65e5\u5fd7\u6253\u5370",children:"\u65e5\u5fd7\u6253\u5370"}),"\n",(0,r.jsxs)(n.p,{children:["\u63d0\u4f9b\u4e86\u4e09\u4e2a\u4e0d\u540c\u7ea7\u522b\u7684",(0,r.jsx)(n.code,{children:"Binder"}),"\u65e5\u5fd7\u8f93\u51fa\uff0c\u7ea7\u522b\u53ef\u53e0\u52a0\uff0c\u7531\u4e8e\u5e94\u7528\u8fdb\u7a0b",(0,r.jsx)(n.code,{children:"Binder"}),"\u901a\u4fe1\u673a\u5668\u9891\u7e41\uff0c\u56e0\u6b64\u5efa\u8bae\u901a\u5e38\u53ea\u9700\u5f00\u542f",(0,r.jsx)(n.code,{children:"SIMPLE"}),"\u7ea7\u522b\u5373\u53ef\u3002"]}),"\n",(0,r.jsx)(n.p,{children:"\u63a5\u53e3\u5b9a\u4e49\u5982\u4e0b\uff1a"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-java",children:"package android.app.ifma.mts.binderceptor;\n\npublic class BinderceptorManager {\n    // \u9996\u5148\u9700\u8981\u521d\u59cb\u5316\n    public static void init() {\n        callNative(INIT, 0, null);\n    }\n\n    public static int EBinderceptorDemoFlag_Print_Simple           = 0x1;\n    public static int EBinderceptorDemoFlag_Print_Transaction_Data = 0x2;\n    public static int EBinderceptorDemoFlag_Print_Write_Read       = 0x4;\n  \n    // \u9ed8\u8ba4\u4e0d\u8f93\u51fa\u65e5\u5fd7\uff0c\u53ef\u4ee5\u8bbe\u7f6e\u65e5\u5fd7\u8f93\u51fa\u7ea7\u522b\n    public static void setLogger(int flag) {\n        callNative(SET_LOGGER, flag, null);\n    }\n}\n"})}),"\n",(0,r.jsx)(n.h4,{id:"simple\u65e5\u5fd7",children:"Simple\u65e5\u5fd7"}),"\n",(0,r.jsxs)(n.p,{children:["\u8f93\u51fa\u5185\u5bb9\u5982\u4e0b\uff1a\uff08\u5305\u542b",(0,r.jsx)(n.code,{children:"Binder"}),"\u670d\u52a1\u540d\u79f0\u548c\u65b9\u6cd5",(0,r.jsx)(n.code,{children:"Code"}),"\u503c\uff09"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-tex",children:"Binder::tgt: 0x9e77682, 10002: com.huawei.iaware.sdk.ISDKManager\nBinder::tgt: 0x3887b52, 147: android.content.pm.IPackageManager\nBinder::tgt: 0x76c2822, 56: com.huawei.android.view.IHwWindowManager\nBinder::tgt: 0xdc3c612, 41: com.huawei.android.app.IHwActivityTaskManager\nBinder::tgt: 0x367556e, 2: android.view.IWindowSession\nBinder::tgt: 0x255ce27, 3: android.magicwin.IHwMagicWindow\nBinder::tgt: 0x76c2822, 56: com.huawei.android.view.IHwWindowManager\nBinder::tgt: 0x984dc75, 24: android.content.pm.IShortcutService\nBinder::tgt: 0x9a978a2, 21: android.content.IContentProvider\nBinder::tgt: 0x19c1b12, 10: android.aps.IHwApsManager\n"})}),"\n",(0,r.jsx)(n.h4,{id:"transaction_data\u65e5\u5fd7",children:"Transaction_Data\u65e5\u5fd7\uff1a"}),"\n",(0,r.jsxs)(n.p,{children:["\u8f93\u51fa\u5185\u5bb9\u5982\u4e0b\uff1a\uff08\u5305\u542b",(0,r.jsx)(n.code,{children:"txn"}),"\u5b8c\u6574\u6570\u636e\u7ed3\u6784\u5185\u5bb9\uff0c\u7279\u522b\u662f\u53c2\u6570\u5185\u5bb9\uff09"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-tex",children:"Trace   : target:       1   cookie:       0   code:      23   flags:   0x12(READ REPLY)\nTrace   :    pid:       0      uid:       0   size:     196    offs:8\nTrace   : 00000000:  00 00 00 80 ff ff ff ff  54 53 59 53 1c 00 00 00  ........TSYS....\nTrace   : 00000010:  61 00 6e 00 64 00 72 00  6f 00 69 00 64 00 2e 00  a.n.d.r.o.i.d...\nTrace   : 00000020:  61 00 70 00 70 00 2e 00  49 00 41 00 63 00 74 00  a.p.p...I.A.c.t.\nTrace   : 00000030:  69 00 76 00 69 00 74 00  79 00 4d 00 61 00 6e 00  i.v.i.t.y.M.a.n.\nTrace   : 00000040:  61 00 67 00 65 00 72 00  00 00 00 00 85 2a 62 73  a.g.e.r......*bs\nTrace   : 00000050:  13 01 00 00 00 38 dd 2a  71 00 00 b4 00 05 e9 31  .....8.*q......1\nTrace   : 00000060:  71 00 00 b4 01 00 00 0c  1a 00 00 00 63 00 6f 00  q...........c.o.\nTrace   : 00000070:  6d 00 2e 00 69 00 66 00  6d 00 61 00 2e 00 74 00  m...i.f.m.a...t.\nTrace   : 00000080:  72 00 61 00 6e 00 73 00  65 00 63 00 2e 00 63 00  r.a.n.s.e.c...c.\nTrace   : 00000090:  6f 00 6e 00 74 00 61 00  69 00 6e 00 65 00 72 00  o.n.t.a.i.n.e.r.\nTrace   : 000000a0:  00 00 00 00 08 00 00 00  73 00 65 00 74 00 74 00  ........s.e.t.t.\nTrace   : 000000b0:  69 00 6e 00 67 00 73 00  00 00 00 00 00 00 00 00  i.n.g.s.........\nTrace   : 000000c0:  01 00 00 00                                       ....\nTrace   : binder object offs:0x4c  type:0x73622a85  flags:0x113  ptr:0x2add3800  cookie:0x31e90500\n"})}),"\n",(0,r.jsx)(n.h4,{id:"write_read\u65e5\u5fd7",children:"Write_Read\u65e5\u5fd7\uff1a"}),"\n",(0,r.jsxs)(n.p,{children:["\u8f93\u51fa\u5185\u5bb9\u5982\u4e0b\uff1a\uff08\u5305\u542b\u7b2c\u4e00\u5c42",(0,r.jsx)(n.code,{children:"Binder"}),"\u901a\u4fe1\u547d\u4ee4\u5185\u5bb9\uff09"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"write_buffer:0xb400007107d1d400, write_consumed:68, write_size:68\n00000000:  00 63 40 40 14 00 00 00  00 00 00 00 00 00 00 00  .c@@............\n00000010:  00 00 00 00 01 00 00 00  12 00 00 00 00 00 00 00  ................\n00000020:  00 00 00 00 54 00 00 00  00 00 00 00 00 00 00 00  ....T...........\n00000030:  00 00 00 00 00 4d 3a ac  70 00 00 b4 00 00 00 00  .....M:.p.......\n00000040:  00 00 00 00                                       ....\nBR_NOOP: 0x720c\nBR_TRANSACTION_COMPLETE: 0x7206\nBR_REPLY: 0\n"})}),"\n",(0,r.jsx)(n.h3,{id:"\u53c2\u6570\u8fc7\u6ee4",children:"\u53c2\u6570\u8fc7\u6ee4"}),"\n",(0,r.jsxs)(n.p,{children:["\u7531\u4e8e",(0,r.jsx)(n.code,{children:"Binder"}),"\u901a\u4fe1\u65e5\u5fd7\u7e41\u591a\uff0c\u65e0\u6cd5\u7504\u522b\uff0c\u56e0\u6b64\u6211\u4eec\u9700\u8981\u8fc7\u6ee4\u63a5\u53e3\uff0c\u6bd4\u5982\u53ea\u9700\u8981\u6253\u5370\u90a3\u4e9b\u65b9\u6cd5\u7684\u53c2\u6570\u4e2d\u5305\u542b\u76ee\u6807\u5185\u5bb9\u3002\u5982\u53ea\u6253\u5370\u90a3\u4e9b",(0,r.jsx)(n.code,{children:"Binder"}),'\u901a\u4fe1\u4e2d\u5305\u542b\u5b57\u7b26\u4e32"com.demo"\uff08',(0,r.jsx)(n.code,{children:"Binder"}),"\u901a\u4fe1\u5b57\u7b26\u901a\u5e38\u4e3a",(0,r.jsx)(n.code,{children:"uint16_t"}),"\u5bbd\u5b57\u7b26\uff09\u5185\u5bb9\u7684\u8c03\u7528\u65e5\u5fd7\u3002"]}),"\n",(0,r.jsxs)(n.p,{children:["\u7531\u4e8eBinder\u901a\u4fe1\u8c03\u7528\u5206\u4e3a\u540c\u6b65\uff08",(0,r.jsx)(n.code,{children:"target"}),"\uff09\u548c\u5f02\u6b65\uff08",(0,r.jsx)(n.code,{children:"oneway"}),"\uff09\u4e24\u79cd\u65b9\u5f0f\uff0c\u56e0\u6b64\u9700\u8981\u5728\u5bf9\u5e94\u7684\u4e24\u4e2a\u65b9\u6cd5\u56de\u8c03\u4e2d\u5904\u7406\uff0c\u5982\uff1a"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-c++",children:"// target argument\uff1acom.demo\nstatic uint16_t g_debug_target[] = {'c','o','m','.','d','e','m','o'};\nstatic const uint32_t g_debug_target_length = 8;\n\nstatic bool doCheckService(binder_txn_st* txn, TBinderInfo& pInfo, TBinderTokenItem& token, bool oneway) {\n    if ((txn->data_size < sizeof(g_debug_target) + sizeof(int32_t))) return false;\n\n    const uint8_t *ptr = (const uint8_t *) txn->data.ptr.buffer;\n    for (int i=0, len = txn->data_size-sizeof(g_debug_target)-sizeof(int32_t); i <= len; ++i) {\n        uint32_t* intPtr = (uint32_t*)(ptr + i);\n        if (*intPtr != g_debug_target_length) continue;// fast length check\n        if (memcmp(ptr + i + sizeof(int32_t), g_debug_target, sizeof(g_debug_target)) != 0) continue;\n\n        // match then print\n        token.print(txn, oneway);\n    }\n\n    return true;\n}\n\nbool BinderceptorDebug::onFrameworkBinderTarget(binder_txn_st* txn, TBinderInfo& pInfo, TBinderTokenItem& token) {\n    if (token.isInvalid()) return false;\n    return doCheckService(txn, pInfo, token, false);\n}\n\nbool BinderceptorDebug::onFrameworkBinderOneway(binder_txn_st* txn, TBinderInfo& pInfo, TBinderTokenItem& token) {\n    if (token.isInvalid()) return false;\n    return doCheckService(txn, pInfo, token, true);\n}\n"})}),"\n",(0,r.jsx)(n.h3,{id:"\u6570\u636e\u4fee\u6539",children:"\u6570\u636e\u4fee\u6539"}),"\n",(0,r.jsxs)(n.p,{children:["\u6709\u4e9b\u65f6\u5019\u6211\u4eec\u9700\u8981\u4fee\u6539\u901a\u4fe1\u7684\u53c2\u6570\uff0c\u8fd9\u91cc\u6211\u4eec\u4ee5\u5f53\u5e94\u7528\u67e5\u627e\u5bf9\u5e94\u5e94\u7528\uff08",(0,r.jsx)(n.code,{children:"com.demo"}),"\uff09\u662f\u5426\u5b58\u5728\u65f6\uff0c\u6211\u4eec\u59cb\u7ec8\u8fd4\u56de\u4e0d\u5b58\u5728\u4e3a\u4f8b\uff0c\u5982\uff1a"]}),"\n",(0,r.jsxs)(n.blockquote,{children:["\n",(0,r.jsx)(n.p,{children:"\u8fd9\u91cc\u4ee5\u5e94\u7528\u7a0b\u5e8f\u8c03\u7528\u5982\u4e0b\u65b9\u6cd5\u4e3a\u4f8b\uff1a"}),"\n",(0,r.jsx)(n.p,{children:"PackageInfo getPackageInfo(String packageName, int flags, int userId);"}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-c++",children:"// target server: android.content.pm.IPackageManager\nstatic uint16_t g_debug_server[] = {'a','n','d','r','o','i','d','.','c','o','n','t','e','n','t','.','p','m','.','I','P','a','c','k','a','g','e','M','a','n','a','g','e','r'};\nstatic const uint32_t g_debug_server_length = 34;\n\n// target argument\uff1acom.demo\nstatic uint16_t g_debug_target[] = {'c','o','m','.','d','e','m','o'};\nstatic const uint32_t g_debug_target_length = 8;\n\nstatic bool pms_get_package_info(binder_txn_st* txn, TBinderInfo& pInfo, TBinderTokenItem& token, bool oneway) {\n    BinderParcel* pr = __PARCEL_NEW_DATA((const uint8_t*)(txn->data.ptr.buffer), txn->data_size);\n    if (__UNLIKELY(!pr)) return false;\n    __PARCEL_AUTO_FREE(pr);\n\n    if (0 != pr->skipToken()) return false;// skip strict model and token\n\n    size_t len = 0;\n    const char16_t* pkg16 = pr->readString16Inplace(&len);\n    if (g_debug_target_length != len || !pkg16) return 0;// maybe package name = \"\"\n\n    if (memcmp(pkg16, g_debug_target, sizeof(g_debug_target)) == 0) {\n        // changed the package arguments\n        ((char16_t*)pkg16)[len-1] = ' ';// fix, make sure throw name not found exception\n        return true;\n    }\n    return false;\n}\n\n/**\n *   \u5982\u4f55\u627e\u5230\u5bf9\u5e94\u7684\u65b9\u6cd5Code\uff1a\n *   1. FindClass(\"android/content/pm/IPackageManager$Stub\");\n *   2. \u83b7\u53d6\u9759\u6001\u6210\u5458\u7684\u503c\uff1a\"TRANSACTION_getPackageInfo\"\n */\nbool BinderceptorDebug::onFrameworkBinderTarget(binder_txn_st* txn, TBinderInfo& pInfo, TBinderTokenItem& token) {\n    if (token.isInvalid()) return false;\n    if (txn->code == 10) {\n    \t   return doCheckService(txn, pInfo, token, false);\n    }\n    return false;\n}\n\nbool BinderceptorDebug::onFrameworkBinderOneway(binder_txn_st* txn, TBinderInfo& pInfo, TBinderTokenItem& token) {\n    if (token.isInvalid()) return false;\n    if (txn->code == 10 && token.isTargetToken(g_debug_server, g_debug_server_length)) {\n    \t   return doCheckService(txn, pInfo, token, true);\n    }\n    return false;\n}\n"})}),"\n",(0,r.jsx)(n.h3,{id:"\u8c03\u7528\u62e6\u622a",children:"\u8c03\u7528\u62e6\u622a"}),"\n",(0,r.jsx)(n.p,{children:"\u5982\u679c\u9700\u8981\u76f4\u63a5\u62d2\u7edd\u8c03\u7528\u6b64\u51fd\u6570\uff0c\u5219\u9700\u8981\u544a\u8bc9Binder\u62e6\u622a\u6846\u67b6\uff0c\u7136\u540e\u5904\u7406\u62e6\u622a\u540e\u8fd4\u56de\u7684\u6570\u636e\u3002"}),"\n",(0,r.jsxs)(n.blockquote,{children:["\n",(0,r.jsx)(n.p,{children:"\u8fd9\u91cc\u4ee5\u5e94\u7528\u7a0b\u5e8f\u8c03\u7528\u5982\u4e0b\u65b9\u6cd5\u4e3a\u4f8b\uff1a"}),"\n",(0,r.jsx)(n.p,{children:"ParcelFileDescriptor openDevice(String deviceName, String packageName);"}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-c++",children:"#define BINDER_TARGET_SERVER\t\t\t\t  1// do not changed\n#define BINDER_TARGET_SERVER_OPEN_DEVICE\t\t1\n\n// target server: android.hardware.usb.IUsbManager\nstatic uint16_t g_debug_server[] = {'a','n','d','r','o','i','d','.''h','a','r','d','w','a','r','e','.','u','s','b','.','I','U','s','b','M','a','n','a','g','e','r'};\nstatic const uint32_t g_debug_server_length = 32;\n\n/**\n *   \u5982\u4f55\u627e\u5230\u5bf9\u5e94\u7684\u65b9\u6cd5Code\uff1a\n *   1. FindClass(\"android/hardware/usb/IUsbManager$Stub\");\n *   2. \u83b7\u53d6\u9759\u6001\u6210\u5458\u7684\u503c\uff1a\"TRANSACTION_OpenDdevice\"\n */\nbool BinderceptorDebug::onFrameworkBinderTarget(binder_txn_st* txn, TBinderInfo& pInfo, TBinderTokenItem& token) {\n    if (token.isInvalid()) return false;\n    if (txn->code == 10) {\n    \t   return doCheckService(txn, pInfo, token, false);\n    }\n    return false;\n}\n\nbool BinderceptorDebug::onFrameworkBinderOneway(binder_txn_st* txn, TBinderInfo& pInfo, TBinderTokenItem& token) {\n    if (token.isInvalid()) return false;\n  \n    if (txn->code == 10 && token.isTargetToken(g_debug_server, g_debug_server_length)) {\n         pInfo.type = BINDER_TARGET_SERVER;\n         pInfo.method = BINDER_TARGET_SERVER_OPEN_DEVICE;\n         pInfo.addAction(EIoctlAction_After_Faker);\n    \t   return true;\n    }\n    return false;\n}\n\nvoid BinderceptorDebug::onFrameworkBinderAfterFaker(BinderParcel& reply, TBinderInfo& pInfo) {\n    // \u5728\u8fd9\u91cc\u4fee\u590d\u8fd4\u56de\u7684\u7ed3\u679c\uff0c\u4ee5\u4fdd\u8bc1\u4e0a\u5c42\u8c03\u7528\u4e0d\u51fa\u9519\n    if (BINDER_TARGET_SERVER_OPEN_DEVICE == pInfo.method) {\n        reply.writeInt32(0);// no Exception\n        reply.writeInt32(0);// no object\n    }\n}\n"})})]})}function g(e={}){const{wrapper:n}={...(0,i.a)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(l,{...e})}):l(e)}},1151:(e,n,t)=>{t.d(n,{Z:()=>a,a:()=>o});var r=t(7294);const i={},d=r.createContext(i);function o(e){const n=r.useContext(d);return r.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:o(e.components),r.createElement(d.Provider,{value:n},e.children)}}}]);