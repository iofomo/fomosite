<?xml version="1.0" encoding="utf-8"?>
<rss version="2.0" xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:content="http://purl.org/rss/1.0/modules/content/">
    <channel>
        <title>iofomo | Open-source organization Blog</title>
        <link>https://www.iofomo.com/blog</link>
        <description>iofomo | Open-source organization Blog</description>
        <lastBuildDate>Tue, 10 Oct 2023 00:00:00 GMT</lastBuildDate>
        <docs>https://validator.w3.org/feed/docs/rss2.html</docs>
        <generator>https://github.com/jpmonette/feed</generator>
        <language>zh</language>
        <item>
            <title><![CDATA[深入Binder拦截]]></title>
            <link>https://www.iofomo.com/blog/Binder</link>
            <guid>https://www.iofomo.com/blog/Binder</guid>
            <pubDate>Tue, 10 Oct 2023 00:00:00 GMT</pubDate>
            <description><![CDATA[基于底层动态拦截技术，实现对Android平台下应用进程Binder通信协议的动态分析和拦截。]]></description>
            <content:encoded><![CDATA[<blockquote>
<p>基于底层动态拦截技术，实现对Android平台下应用进程Binder通信协议的动态分析和拦截。</p>
</blockquote>
<p><a href="https://www.github.com/iofomo/binderceptor" target="_blank" rel="noopener noreferrer">☞ Github ☜</a>　　<a href="https://www.gitee.com/iofomo/binderceptor" target="_blank" rel="noopener noreferrer">☞ Gitee ☜</a></p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="说明">说明<a href="https://www.iofomo.com/blog/Binder#%E8%AF%B4%E6%98%8E" class="hash-link" aria-label="说明的直接链接" title="说明的直接链接">​</a></h3>
<p><code>Binder</code>作为<code>Android</code>系统跨进程通信的核心机制。网上也有很多深度讲解该机制的文章，如：</p>
<ul>
<li><a href="https://blog.csdn.net/carson_ho/article/details/73560642" target="_blank" rel="noopener noreferrer">Android跨进程通信详解Binder机制原理</a></li>
<li><a href="https://blog.51cto.com/u_14344871/3370037" target="_blank" rel="noopener noreferrer">Android系统核心机制Binder【系列】</a></li>
</ul>
<p>这些文章和系统源码可以很好帮助我们理解Binder的实现原理和设计理念，为拦截做准备。借助Binder拦截可以我们可以扩展出那些能力呢：</p>
<ol>
<li>虚拟化的能力，多年前就出现的应用免安装运行类产品如：<code>VirtualApp</code>/<code>DroidPlugin</code>/平行空间/双开大师/应用分身等。</li>
<li>测试验证的能力，通常为<code>Framework</code>层功能开发。</li>
<li>检测第三方<code>SDK</code>或模块系统服务调用访问情况（特别是敏感<code>API</code>调用）。</li>
<li>逆向分析应用底层服务接口调用实现。</li>
<li>第三方<code>ROM</code>扩展<code>Framework</code>服务。</li>
</ol>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="现有方案">现有方案<a href="https://www.iofomo.com/blog/Binder#%E7%8E%B0%E6%9C%89%E6%96%B9%E6%A1%88" class="hash-link" aria-label="现有方案的直接链接" title="现有方案的直接链接">​</a></h3>
<p>一直以来实时分析和拦截进程的<code>Binder</code>通信是通过<code>Java</code>层的<code>AIDL</code>接口代理来实现的。借助于<code>Android</code>系统<code>Binder</code>服务接口设计的规范，上层的接口均继承于<code>IBinder</code>。</p>
<p>如一下为代理目标对象的所有的接口<code>API</code>的方法：</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">import java.lang.reflect.InvocationHandler;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.lang.reflect.InvocationTargetException;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.lang.reflect.Proxy;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">private static void getInterface(Class&lt;?&gt; cls, final HashSet&lt;Class&lt;?&gt;&gt; ss) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Class&lt;?&gt;[] ii;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    do {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ii = cls.getInterfaces();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (final Class&lt;?&gt; i : ii) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (ss.add(i)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                getInterface(i, ss);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        cls = cls.getSuperclass();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    } while (cls != null);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">private static Class&lt;?&gt;[] getInterfaces(Class&lt;?&gt; cls) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    final HashSet&lt;Class&lt;?&gt;&gt; ss = new LinkedHashSet&lt;Class&lt;?&gt;&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    getInterface(cls, ss);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (0 &lt; ss.size()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ss.toArray(new Class&lt;?&gt;[ss.size()]);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public static Object createProxy(Object org, InvocationHandler cb) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Class&lt;?&gt; cls = org.getClass();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Class&lt;?&gt;[] cc = getInterfaces(cls);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return Proxy.newProxyInstance(cls.getClassLoader(), cc, cb);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    } catch (Throwable e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Logger.e(e);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    } finally {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // TODO release fix proxy name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>1、对于已经生成的<code>Binder</code>服务对象，在应用进程可参与实现逻辑之前就已经缓存了，我们需要找到并且进行替换（<code>AMS、PMS、WMS等</code>），如<code>AMS</code>在Android 8.0之后的缓存如下：</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// source code: http://aospxref.com/android-9.0.0_r61/xref/frameworks/base/core/java/android/app/ActivityManager.java</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">package android.app;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class ActivityManager {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static IActivityManager getService() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return IActivityManagerSingleton.get();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final Singleton&lt;IActivityManager&gt; IActivityManagerSingleton =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            new Singleton&lt;IActivityManager&gt;() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                protected IActivityManager create() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    final IBinder b = ServiceManager.getService(Context.ACTIVITY_SERVICE);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    final IActivityManager am = IActivityManager.Stub.asInterface(b);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    return am;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            };</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>因此我们需要找到并且替换它，如：</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Object obj;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if (Build.VERSION.SDK_INT &lt; 26) {// &lt;= 7.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    obj = ReflectUtils.getStaticFieldValue("android.app.ActivityManagerNative", "gDefault");</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">} else {// 8.0 &lt;=</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    obj = ReflectUtils.getStaticFieldValue("android.app.ActivityManager", "IActivityManagerSingleton");</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Object inst = ReflectUtils.getFieldValue(obj, "mInstance");</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ReflectUtils.setFieldValue(obj, "mInstance", createProxy(inst));</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>2、对于后续运行过程中才获取的<code>Binder</code>服务，则需要代理<code>ServiceManager</code>，源码如下：</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// source code: http://aospxref.com/android-9.0.0_r61/xref/frameworks/base/core/java/android/os/ServiceManager.java</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">package android.os;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public final class ServiceManager {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final String TAG = "ServiceManager";</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static IServiceManager sServiceManager;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>因此我们的代理如下：</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Class&lt;?&gt; cls = ReflectUtils.findClass("android.os.ServiceManager");</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Object org = ReflectUtils.getStaticFieldValue(cls, "sServiceManager");</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Object pxy = new createProxy(org);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if (null != pxy) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ReflectUtils.setStaticFieldValue(getGlobalClass(), "sServiceManager", pxy);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>这样每次在第一次访问该服务时，就会调用<code>IServiceManager</code>中的<code>getService</code>的方法，而该方法已经被我们代理拦截，我们可以通过参数可以识别当前获取的是哪个服务，然后将获取的服务对象代理后在继续返回即可。</p>
<p><code>但是：</code>这样的方案并不能拦截进程中所有的<code>Binder</code>服务。我们面临几大问题：</p>
<ol>
<li>
<p>首先，Android源码越来越庞大，了解所有的服务工作量很大，因此有哪些服务已经被缓存排查非常困难。</p>
</li>
<li>
<p>其次，厂商越来越钟情于扩展自定义服务，这些服务不开源，识别和适配更加耗时。</p>
</li>
<li>
<p>再次，有一部分服务只有<code>native</code>实现，并不能通过<code>Java</code>层的接口代理进行拦截（如：<code>Sensor/Audio/Video/Camera服务等</code>）。</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// source code: http://aospxref.com/android-13.0.0_r3/xref/frameworks/av/camera/ICamera.cpp</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class BpCamera</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> public BpInterface</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">ICamera</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    explicit </span><span class="token function" style="color:#d73a49">BpCamera</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> sp</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">IBinder</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> impl</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> BpInterface</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">ICamera</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">impl</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// start recording mode, must call setPreviewTarget first</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">status_t</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">startRecording</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">ALOGV</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"startRecording"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Parcel data</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> reply</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        data</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">writeInterfaceToken</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ICamera</span><span class="token operator" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">getInterfaceDescriptor</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">remote</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token function" style="color:#d73a49">transact</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">START_RECORDING</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> data</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">reply</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> reply</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">readInt32</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
</ol>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="新方案基于底层拦截">新方案：基于底层拦截<a href="https://www.iofomo.com/blog/Binder#%E6%96%B0%E6%96%B9%E6%A1%88%E5%9F%BA%E4%BA%8E%E5%BA%95%E5%B1%82%E6%8B%A6%E6%88%AA" class="hash-link" aria-label="新方案：基于底层拦截的直接链接" title="新方案：基于底层拦截的直接链接">​</a></h3>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="原理">原理<a href="https://www.iofomo.com/blog/Binder#%E5%8E%9F%E7%90%86" class="hash-link" aria-label="原理的直接链接" title="原理的直接链接">​</a></h4>
<p>我们都知道<code>Binder</code>在应用进程运行原理如下图：</p>
<p><img loading="lazy" src="https://www.iofomo.com/assets/images/topic-binderceptor-217f3dec9af01feb4171dd4d2f69b120.png" width="862" height="719" class="img_ev3q"></p>
<p>不管是<code>Java</code>层还是<code>native</code>层的接口调用，最后都会通过<code>ioctl</code>函数访问共享内存空间，达到跨进程访问数据交换的目的。因此我们只要拦截<code>ioctl</code>函数，即可完成对所有<code>Binder</code>通信数据的拦截。底层拦截有以下优势：</p>
<p>1）可以拦截所有的Binder通信。</p>
<p>2）底层拦截稳定，高兼容性。从<code>Android 4.x</code>至<code>Android 14</code>，近10年的系统版本演进，涉及到<code>Binder</code>底层通信适配仅两次；一次是支持64位进程（当时需要同时兼容32位和64位进程访问<code>Binder</code>服务）。另一次是华为鸿蒙系统的诞生，华为<code>ROM</code>在<code>Binder</code>通信协议中增加了新的标识字段。</p>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="要解决的问题">要解决的问题<a href="https://www.iofomo.com/blog/Binder#%E8%A6%81%E8%A7%A3%E5%86%B3%E7%9A%84%E9%97%AE%E9%A2%98" class="hash-link" aria-label="要解决的问题的直接链接" title="要解决的问题的直接链接">​</a></h4>
<h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="如何拦截">如何拦截<a href="https://www.iofomo.com/blog/Binder#%E5%A6%82%E4%BD%95%E6%8B%A6%E6%88%AA" class="hash-link" aria-label="如何�拦截的直接链接" title="如何拦截的直接链接">​</a></h5>
<p><code>C/C++</code>层的函数拦截，并不像<code>Java</code>层一样系统提供了较为稳定的代理工具，在这里不是我们本期讨论的重点，可以直接采用网上开源的<code>Hook</code>框架：</p>
<ul>
<li><a href="https://github.com/bytedance/android-inline-hook" target="_blank" rel="noopener noreferrer">https://github.com/bytedance/android-inline-hook</a></li>
<li><a href="https://github.com/bytedance/bhook" target="_blank" rel="noopener noreferrer">https://github.com/bytedance/bhook</a></li>
<li><a href="https://github.com/asLody/whale" target="_blank" rel="noopener noreferrer">https://github.com/asLody/whale</a></li>
</ul>
<h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="如何过滤">如何过滤<a href="https://www.iofomo.com/blog/Binder#%E5%A6%82%E4%BD%95%E8%BF%87%E6%BB%A4" class="hash-link" aria-label="如何过滤的直接链接" title="如何过滤的直接链接">​</a></h5>
<p><code>ioctl</code>函数为系统底层设备访问函数，调用及其频繁，而<code>Binder</code>通信调用只是其中调用者之一，因此需要快速识别非<code>Binder</code>通信调用，不影响程序性能。</p>
<p>函数定义：</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">include</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property string" style="color:#e3116c">&lt;sys/ioctl.h&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">ioctl</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> fildes</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">unsigned</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">long</span><span class="token plain"> request</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><code>request</code>的参数定义：</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// source code: http://aospxref.com/android-14.0.0_r2/xref/bionic/libc/kernel/uapi/linux/android/binder.h</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">define</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property macro-name" style="color:#36acaa">BINDER_WRITE_READ</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property expression function" style="color:#d73a49">_IOWR</span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property char" style="color:#36acaa">'b'</span><span class="token macro property expression punctuation" style="color:#393A34">,</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression number" style="color:#36acaa">1</span><span class="token macro property expression punctuation" style="color:#393A34">,</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression keyword" style="color:#00009f">struct</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression class-name" style="color:#36acaa">binder_write_read</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">define</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property macro-name" style="color:#36acaa">BINDER_SET_IDLE_TIMEOUT</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property expression function" style="color:#d73a49">_IOW</span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property char" style="color:#36acaa">'b'</span><span class="token macro property expression punctuation" style="color:#393A34">,</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression number" style="color:#36acaa">3</span><span class="token macro property expression punctuation" style="color:#393A34">,</span><span class="token macro property expression" style="color:#36acaa"> __s64</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">define</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property macro-name" style="color:#36acaa">BINDER_SET_MAX_THREADS</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property expression function" style="color:#d73a49">_IOW</span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property char" style="color:#36acaa">'b'</span><span class="token macro property expression punctuation" style="color:#393A34">,</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression number" style="color:#36acaa">5</span><span class="token macro property expression punctuation" style="color:#393A34">,</span><span class="token macro property expression" style="color:#36acaa"> __u32</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">define</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property macro-name" style="color:#36acaa">BINDER_SET_IDLE_PRIORITY</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property expression function" style="color:#d73a49">_IOW</span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property char" style="color:#36acaa">'b'</span><span class="token macro property expression punctuation" style="color:#393A34">,</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression number" style="color:#36acaa">6</span><span class="token macro property expression punctuation" style="color:#393A34">,</span><span class="token macro property expression" style="color:#36acaa"> __s32</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">define</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property macro-name" style="color:#36acaa">BINDER_SET_CONTEXT_MGR</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property expression function" style="color:#d73a49">_IOW</span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property char" style="color:#36acaa">'b'</span><span class="token macro property expression punctuation" style="color:#393A34">,</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression number" style="color:#36acaa">7</span><span class="token macro property expression punctuation" style="color:#393A34">,</span><span class="token macro property expression" style="color:#36acaa"> __s32</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">define</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property macro-name" style="color:#36acaa">BINDER_THREAD_EXIT</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property expression function" style="color:#d73a49">_IOW</span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property char" style="color:#36acaa">'b'</span><span class="token macro property expression punctuation" style="color:#393A34">,</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression number" style="color:#36acaa">8</span><span class="token macro property expression punctuation" style="color:#393A34">,</span><span class="token macro property expression" style="color:#36acaa"> __s32</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">define</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property macro-name" style="color:#36acaa">BINDER_VERSION</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property expression function" style="color:#d73a49">_IOWR</span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property char" style="color:#36acaa">'b'</span><span class="token macro property expression punctuation" style="color:#393A34">,</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression number" style="color:#36acaa">9</span><span class="token macro property expression punctuation" style="color:#393A34">,</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression keyword" style="color:#00009f">struct</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression class-name" style="color:#36acaa">binder_version</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">define</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property macro-name" style="color:#36acaa">BINDER_GET_NODE_DEBUG_INFO</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property expression function" style="color:#d73a49">_IOWR</span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property char" style="color:#36acaa">'b'</span><span class="token macro property expression punctuation" style="color:#393A34">,</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression number" style="color:#36acaa">11</span><span class="token macro property expression punctuation" style="color:#393A34">,</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression keyword" style="color:#00009f">struct</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression class-name" style="color:#36acaa">binder_node_debug_info</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">define</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property macro-name" style="color:#36acaa">BINDER_GET_NODE_INFO_FOR_REF</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property expression function" style="color:#d73a49">_IOWR</span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property char" style="color:#36acaa">'b'</span><span class="token macro property expression punctuation" style="color:#393A34">,</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression number" style="color:#36acaa">12</span><span class="token macro property expression punctuation" style="color:#393A34">,</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression keyword" style="color:#00009f">struct</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression class-name" style="color:#36acaa">binder_node_info_for_ref</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">define</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property macro-name" style="color:#36acaa">BINDER_SET_CONTEXT_MGR_EXT</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property expression function" style="color:#d73a49">_IOW</span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property char" style="color:#36acaa">'b'</span><span class="token macro property expression punctuation" style="color:#393A34">,</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression number" style="color:#36acaa">13</span><span class="token macro property expression punctuation" style="color:#393A34">,</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression keyword" style="color:#00009f">struct</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression class-name" style="color:#36acaa">flat_binder_object</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">define</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property macro-name" style="color:#36acaa">BINDER_FREEZE</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property expression function" style="color:#d73a49">_IOW</span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property char" style="color:#36acaa">'b'</span><span class="token macro property expression punctuation" style="color:#393A34">,</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression number" style="color:#36acaa">14</span><span class="token macro property expression punctuation" style="color:#393A34">,</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression keyword" style="color:#00009f">struct</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression class-name" style="color:#36acaa">binder_freeze_info</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">define</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property macro-name" style="color:#36acaa">BINDER_GET_FROZEN_INFO</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property expression function" style="color:#d73a49">_IOWR</span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property char" style="color:#36acaa">'b'</span><span class="token macro property expression punctuation" style="color:#393A34">,</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression number" style="color:#36acaa">15</span><span class="token macro property expression punctuation" style="color:#393A34">,</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression keyword" style="color:#00009f">struct</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression class-name" style="color:#36acaa">binder_frozen_status_info</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">define</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property macro-name" style="color:#36acaa">BINDER_ENABLE_ONEWAY_SPAM_DETECTION</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property expression function" style="color:#d73a49">_IOW</span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property char" style="color:#36acaa">'b'</span><span class="token macro property expression punctuation" style="color:#393A34">,</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression number" style="color:#36acaa">16</span><span class="token macro property expression punctuation" style="color:#393A34">,</span><span class="token macro property expression" style="color:#36acaa"> __u32</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">define</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property macro-name" style="color:#36acaa">BINDER_GET_EXTENDED_ERROR</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property expression function" style="color:#d73a49">_IOWR</span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property char" style="color:#36acaa">'b'</span><span class="token macro property expression punctuation" style="color:#393A34">,</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression number" style="color:#36acaa">17</span><span class="token macro property expression punctuation" style="color:#393A34">,</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression keyword" style="color:#00009f">struct</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression class-name" style="color:#36acaa">binder_extended_error</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复�制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>对应的源码：</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// source code: http://aospxref.com/android-14.0.0_r2/xref/frameworks/native/libs/binder/IPCThreadState.cpp</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> IPCThreadState</span><span class="token operator" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">threadDestructor</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">st</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token function" style="color:#d73a49">ioctl</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">mProcess</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">mDriverFD</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> BINDER_THREAD_EXIT</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token class-name">status_t</span><span class="token plain"> IPCThreadState</span><span class="token operator" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">getProcessFreezeInfo</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">pid_t</span><span class="token plain"> pid</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">uint32_t</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">sync_received</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">uint32_t</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">async_received</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">ioctl</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">self</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">mProcess</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">mDriverFD</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> BINDER_GET_FROZEN_INFO</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">info</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token class-name">status_t</span><span class="token plain"> IPCThreadState</span><span class="token operator" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">freeze</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">pid_t</span><span class="token plain"> pid</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> bool enable</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">uint32_t</span><span class="token plain"> timeout_ms</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">ioctl</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">self</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">mProcess</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">mDriverFD</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> BINDER_FREEZE</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">info</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> IPCThreadState</span><span class="token operator" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">logExtendedError</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">ioctl</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">self</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">mProcess</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">mDriverFD</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> BINDER_GET_EXTENDED_ERROR</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">ee</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token class-name">status_t</span><span class="token plain"> IPCThreadState</span><span class="token operator" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">talkWithDriver</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">bool doReceive</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 实际Binder调用通信</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">ioctl</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">mProcess</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">mDriverFD</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> BINDER_WRITE_READ</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">bwr</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>快速过滤：</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">ioctl_hook</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> fd</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> cmd</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> arg</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">cmd </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> BINDER_WRITE_READ </span><span class="token operator" style="color:#393A34">||</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!</span><span class="token plain">arg </span><span class="token operator" style="color:#393A34">||</span><span class="token plain"> g_ioctl_disabled</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">g_ioctl_func</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">fd</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> cmd</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> arg</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="如何解析">如何解析<a href="https://www.iofomo.com/blog/Binder#%E5%A6%82%E4%BD%95%E8%A7%A3%E6%9E%90" class="hash-link" aria-label="如何解析的直接链接" title="如何解析的直接链接">​</a></h5>
<p>目标源码：<a href="http://aospxref.com/android-14.0.0_r2/xref/frameworks/native/libs/binder" target="_blank" rel="noopener noreferrer">http://aospxref.com/android-14.0.0_r2/xref/frameworks/native/libs/binder</a></p>
<p>重点解析发送（即<code>BC_TRANSACTION</code>和<code>BC_REPLY</code>）和接收（即<code>BR_TRANSACTION</code>和<code>BR_REPLY</code>）的类型数据。</p>
<h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="如何修改数据">如何修改数据<a href="https://www.iofomo.com/blog/Binder#%E5%A6%82%E4%BD%95%E4%BF%AE%E6%94%B9%E6%95%B0%E6%8D%AE" class="hash-link" aria-label="如何修改数据的直接链接" title="如何修改数据的直接链接">​</a></h5>
<p>修改数据分为以下几种：</p>
<p>1）修复调用时参数数据。</p>
<p>2）修复调用后返回的结果数据。</p>
<p>如果数据修复不改变当前数据的长度，只是内容的变化，则可以直接通过地址进行修改。否则需要创建新的内存进行修改后将新的数据地址设置到<code>BINDER_WRITE_READ</code>结构的<code>buffer</code>成员。此时处理好内存的释放问题。</p>
<p>3）直接拦截本次调用。</p>
<p>为了保障稳定性，不打断<code>Binder</code>的调用流程（通常这也是拦截和逆向方案保障稳定的最重要原则之一）。我们可以将目标函数<code>code</code>修改成父类处理的通用方法，然后通过修复调用的返回值即可完成拦截。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="方案实现">方案实现<a href="https://www.iofomo.com/blog/Binder#%E6%96%B9%E6%A1%88%E5%AE%9E%E7%8E%B0" class="hash-link" aria-label="方案实现的直接链接" title="方案实现的直接链接">​</a></h3>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="数据解析">数据解析<a href="https://www.iofomo.com/blog/Binder#%E6%95%B0%E6%8D%AE%E8%A7%A3%E6%9E%90" class="hash-link" aria-label="数据解析的直接链接" title="数据解析的直接链接">​</a></h4>
<p>Binder调用数据结构如下：</p>
<p><img loading="lazy" src="https://www.iofomo.com/assets/images/1-bff2e5dc398b11f79e4987f80f165d47.png" width="826" height="534" class="img_ev3q"></p>
<h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="解析bwr">解析<code>bwr</code><a href="https://www.iofomo.com/blog/Binder#%E8%A7%A3%E6%9E%90bwr" class="hash-link" aria-label="解析bwr的直接链接" title="解析bwr的直接链接">​</a></h5>
<p><code>bwr</code>即<code>binder_write_read</code>，从源码中了解到<code>ioctl</code>的<code>BINDER_WRITE_READ</code>类型的<code>arg</code>数据结构为：</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">binder_write_read</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 调用时传入的数据</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 	</span><span class="token class-name">binder_size_t</span><span class="token plain"> write_size</span><span class="token punctuation" style="color:#393A34">;</span><span class="token comment" style="color:#999988;font-style:italic">// call data</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 	</span><span class="token class-name">binder_size_t</span><span class="token plain"> write_consumed</span><span class="token punctuation" style="color:#393A34">;</span><span class="token comment" style="color:#999988;font-style:italic">// call data</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 	</span><span class="token class-name">binder_uintptr_t</span><span class="token plain"> write_buffer</span><span class="token punctuation" style="color:#393A34">;</span><span class="token comment" style="color:#999988;font-style:italic">// call data</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// 结果返回数据</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 	</span><span class="token class-name">binder_size_t</span><span class="token plain"> read_size</span><span class="token punctuation" style="color:#393A34">;</span><span class="token comment" style="color:#999988;font-style:italic">// recv data</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 	</span><span class="token class-name">binder_size_t</span><span class="token plain"> read_consumed</span><span class="token punctuation" style="color:#393A34">;</span><span class="token comment" style="color:#999988;font-style:italic">// recv data</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 	</span><span class="token class-name">binder_uintptr_t</span><span class="token plain"> read_buffer</span><span class="token punctuation" style="color:#393A34">;</span><span class="token comment" style="color:#999988;font-style:italic">// recv data</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>不管是传入还是返回的数据，都是一组BC命令或BR命令，也就是说一次调用上层会打包几个命令一起传递。因此我们需要通过循环来找到我们的命令。</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">binder_find_for_bc</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">binder_write_read</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> bwr</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">binder_uintptr_t</span><span class="token plain"> cmds </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> bwr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">write_buffer</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">binder_uintptr_t</span><span class="token plain"> end </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> cmds </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">binder_uintptr_t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">bwr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">write_size</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    binder_txn_st</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> txn </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">while</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> cmds </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> cmds </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> end </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!</span><span class="token plain">txn</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// 由于每次Binder通信数据量的限制，Binder设计每次调用有且仅包含一个有效的参数命令，因此只要找到即可，其他类型则直接跳过忽略</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        cmds </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">binder_parse_cmds_bc</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">cmds</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> txn</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><code>dump</code>数据如下：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">write_buffer:0xb400007107d1d400, write_consumed:68, write_size:68</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">00000000:  00 63 40 40 14 00 00 00  00 00 00 00 00 00 00 00  .c@@............</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">00000010:  00 00 00 00 01 00 00 00  12 00 00 00 00 00 00 00  ................</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">00000020:  00 00 00 00 54 00 00 00  00 00 00 00 00 00 00 00  ....T...........</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">00000030:  00 00 00 00 00 4d 3a ac  70 00 00 b4 00 00 00 00  .....M:.p.......</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">00000040:  00 00 00 00                                       ....</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">BR_NOOP: 0x720c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">BR_TRANSACTION_COMPLETE: 0x7206</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">BR_REPLY: 0</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="解析txn">解析<code>txn</code><a href="https://www.iofomo.com/blog/Binder#%E8%A7%A3%E6%9E%90txn" class="hash-link" aria-label="解析txn的直接链接" title="解析txn的直接��链接">​</a></h5>
<p><code>txn</code>即<code>binder_transaction_data</code>，Binder方法调用的方法参数信息定义如下：</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">binder_transaction_data</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token keyword" style="color:#00009f">union</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     __u32 handle</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token class-name">binder_uintptr_t</span><span class="token plain"> ptr</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> target</span><span class="token punctuation" style="color:#393A34">;</span><span class="token comment" style="color:#999988;font-style:italic">// 目标服务句柄，server端使用</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token class-name">binder_uintptr_t</span><span class="token plain"> cookie</span><span class="token punctuation" style="color:#393A34">;</span><span class="token comment" style="color:#999988;font-style:italic">// 缓存的Binder进行访问</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> __u32 code</span><span class="token punctuation" style="color:#393A34">;</span><span class="token comment" style="color:#999988;font-style:italic">//方法编号</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> __u32 flags</span><span class="token punctuation" style="color:#393A34">;</span><span class="token comment" style="color:#999988;font-style:italic">// 标识，如是否为 oneway</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> __s32 sender_pid</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> __u32 sender_euid</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token class-name">binder_size_t</span><span class="token plain"> data_size</span><span class="token punctuation" style="color:#393A34">;</span><span class="token comment" style="color:#999988;font-style:italic">// 数据长度</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token class-name">binder_size_t</span><span class="token plain"> offsets_size</span><span class="token punctuation" style="color:#393A34">;</span><span class="token comment" style="color:#999988;font-style:italic">// 若包含对象，则对象数据大小</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token keyword" style="color:#00009f">union</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         </span><span class="token class-name">binder_uintptr_t</span><span class="token plain"> buffer</span><span class="token punctuation" style="color:#393A34">;</span><span class="token comment" style="color:#999988;font-style:italic">// Binder方法参数值地址</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         </span><span class="token class-name">binder_uintptr_t</span><span class="token plain"> offsets</span><span class="token punctuation" style="color:#393A34">;</span><span class="token comment" style="color:#999988;font-style:italic">// Binder方法参数对象数据地址</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> ptr</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     __u8 buf</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">8</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> data</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><code>dumo</code>数据如下：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Trace   : target:       1   cookie:       0   code:      23   flags:   0x12(READ REPLY)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Trace   :    pid:       0      uid:       0   size:     196    offs:8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Trace   : 00000000:  00 00 00 80 ff ff ff ff  54 53 59 53 1c 00 00 00  ........TSYS....</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Trace   : 00000010:  61 00 6e 00 64 00 72 00  6f 00 69 00 64 00 2e 00  a.n.d.r.o.i.d...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Trace   : 00000020:  61 00 70 00 70 00 2e 00  49 00 41 00 63 00 74 00  a.p.p...I.A.c.t.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Trace   : 00000030:  69 00 76 00 69 00 74 00  79 00 4d 00 61 00 6e 00  i.v.i.t.y.M.a.n.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Trace   : 00000040:  61 00 67 00 65 00 72 00  00 00 00 00 85 2a 62 73  a.g.e.r......*bs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Trace   : 00000050:  13 01 00 00 00 38 dd 2a  71 00 00 b4 00 05 e9 31  .....8.*q......1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Trace   : 00000060:  71 00 00 b4 01 00 00 0c  1a 00 00 00 63 00 6f 00  q...........c.o.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Trace   : 00000070:  6d 00 2e 00 69 00 66 00  6d 00 61 00 2e 00 74 00  m...i.f.m.a...t.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Trace   : 00000080:  72 00 61 00 6e 00 73 00  65 00 63 00 2e 00 63 00  r.a.n.s.e.c...c.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Trace   : 00000090:  6f 00 6e 00 74 00 61 00  69 00 6e 00 65 00 72 00  o.n.t.a.i.n.e.r.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Trace   : 000000a0:  00 00 00 00 08 00 00 00  73 00 65 00 74 00 74 00  ........s.e.t.t.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Trace   : 000000b0:  69 00 6e 00 67 00 73 00  00 00 00 00 00 00 00 00  i.n.g.s.........</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Trace   : 000000c0:  01 00 00 00                                       ....</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Trace   : binder object offs:0x4c  type:0x73622a85  flags:0x113  ptr:0x2add3800  cookie:0x31e90500</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="解析服务名">解析服务名<a href="https://www.iofomo.com/blog/Binder#%E8%A7%A3%E6%9E%90%E6%9C%8D%E5%8A%A1%E5%90%8D" class="hash-link" aria-label="解析服务名的直接链接" title="解析服务名的直接链接">​</a></h5>
<p><code>Binder</code>通信数据头如下，即可解析出目标服务名：</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">find_server_name</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> binder_txn_st</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> txn</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token class-name">int32_t</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> ptr </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> reinterpret_cast</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token class-name">int32_t</span><span class="token operator" style="color:#393A34">*</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">txn</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">data</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ptr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">buffer</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  	</span><span class="token operator" style="color:#393A34">++</span><span class="token plain"> ptr</span><span class="token punctuation" style="color:#393A34">;</span><span class="token comment" style="color:#999988;font-style:italic">// skip strict model</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">29</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">sdkVersion</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">++</span><span class="token plain"> ptr</span><span class="token punctuation" style="color:#393A34">;</span><span class="token comment" style="color:#999988;font-style:italic">// 10.0 &lt;=, skip flags(ff ff ff ff)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  	</span><span class="token class-name">int32_t</span><span class="token plain"> nameLen </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">ptr</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token class-name">uint16_t</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> name16 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token class-name">uint16_t</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ptr</span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="解析方法名">解析方法名<a href="https://www.iofomo.com/blog/Binder#%E8%A7%A3%E6%9E%90%E6%96%B9%E6%B3%95%E5%90%8D" class="hash-link" aria-label="解析方法名的直接链接" title="解析方法名的直接链接">​</a></h5>
<p><code>Binder</code>通信数据中标识该服务方法的参数是<code>txn-&gt;code</code>。<code>AIDL</code>定义类在编译后会为每个方法自动生成静态的方法。</p>
<p>如定义的<code>Binder</code>接口方法为：</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">interface IDemo {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  void test();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  void test2();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>则编译后生成的类为：</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">class IDemo$Stub {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   void test();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   void test2();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  static final int TRANSACTION_test = 1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  static final int TRANSACTION_test2 = 2;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>因此我们可以通过反射的方式，找到服务名对应的类所有静态成员变量，然后找到与<code>code</code>值相等的成员即为此方法。</p>
<blockquote>
<p>这里可能需要解决私有API的限制解除问题。</p>
</blockquote>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// 可直接使用工程工具类</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">TstClassPrinter.printStubByCodes("android.app.IActivityManager", 13, 16, 67);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>日志输出如下：</p>
<p><img loading="lazy" src="https://www.iofomo.com/assets/images/2-48d2a6efe016eb0397ea408bcbc6235b.png" width="1146" height="135" class="img_ev3q"></p>
<h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="解析数据">解析数据<a href="https://www.iofomo.com/blog/Binder#%E8%A7%A3%E6%9E%90%E6%95%B0%E6%8D%AE" class="hash-link" aria-label="解析数据的直接链接" title="解析数据的直接链接">​</a></h5>
<p>首先需要借助数据封装类<code>Parcel</code>。</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// souce code:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// http://aospxref.com/android-14.0.0_r2/xref/frameworks/native/include/binder/Parcel.h</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// http://aospxref.com/android-14.0.0_r2/xref/frameworks/native/libs/binder/Parcel.cpp</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码��到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>借助该类可以解析一些比较简单的数据，快速的找到目标内容。而对于比较复杂的数据，如参数值为<code>Intent</code>，该参数类型嵌套了多层的<code>Parcelable</code>成员，因此在<code>native</code>层通过<code>Parcel</code>来解析，兼容性比较差。因此我们选择通过回调到Java层来解析，修改后再格式化为<code>native</code>的<code>buffer</code>数据。这里需要处理好<code>Java</code>和<code>native</code>层的数据交换问题，以及回收。</p>
<p><code>native</code>层：</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// 创建</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">jobject </span><span class="token function" style="color:#d73a49">obtain</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">JNIEnv</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> env</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    jclass jcls </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> env</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token function" style="color:#d73a49">FindClass</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"android/os/Parcel"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    jmethodID method </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> env</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token function" style="color:#d73a49">GetStaticMethodID</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">jcls</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"obtain"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"()Landroid/os/Parcel;"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token plain">method</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mParcelObj </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> env</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token function" style="color:#d73a49">CallStaticObjectMethod</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">jcls</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> method</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token plain">mParcelObj</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> mUparcel</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token function" style="color:#d73a49">dataSize</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        method </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> env</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token function" style="color:#d73a49">GetMethodID</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">sParcelClass</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"setDataPosition"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"(I)V"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">method</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token function" style="color:#d73a49">unmarshall</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">env</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> mUparcel</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token function" style="color:#d73a49">data</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> mUparcel</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token function" style="color:#d73a49">dataSize</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            env</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token function" style="color:#d73a49">CallVoidMethod</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">mParcelObj</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> method</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> mUparcel</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token function" style="color:#d73a49">dataPosition</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> mParcelObj</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 回收</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">recycle</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">JNIEnv</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> env</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    jclass jcls </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> env</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token function" style="color:#d73a49">FindClass</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"android/os/Parcel"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    jmethodID method </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> env</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token function" style="color:#d73a49">GetMethodID</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">jcls</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"recycle"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"()V"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">method</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token function" style="color:#d73a49">CallVoidMethod</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">mParcelObj</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> method</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">mParcelObj</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token function" style="color:#d73a49">DeleteLocalRef</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">mParcelObj</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mParcelObj </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><code>Java</code>层：</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public static void clearHttpLink(Parcel p/*IN*/, Parcel q/*OUT*/) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Intent ii = Intent.CREATOR.createFromParcel(pp);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		// TODO something ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      	</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // write new data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        q.appendFrom(p, p.dataPosition(), p.dataAvail());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    } catch (Throwable e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        e.printStackTrace();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="数据拦截">数据拦截<a href="https://www.iofomo.com/blog/Binder#%E6%95%B0%E6%8D%AE%E6%8B%A6%E6%88%AA" class="hash-link" aria-label="数据拦截的直接链接" title="数据拦截的直接链接">​</a></h4>
<p>Binder的数据解析和打印不会改变原数据内容，因此相对简单，如果要对数据进行修改，则相对复杂一些。修复的数据需要替换原数据，因此需要进行如下操作。</p>
<p>1、数据替换。</p>
<p>将<code>txn</code>中方法参数的数据指针指向新创建的数据区。</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">binder_replace_txn_for_br</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">binder_txn_st </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">txn</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ParcelEx</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> reply</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">binder_size_t</span><span class="token plain"> _pos</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">size_t</span><span class="token plain"> size </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> reply</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token function" style="color:#d73a49">ipcDataSize</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">uint8_t</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> repData </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">uint8_t</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token function" style="color:#d73a49">malloc</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">size </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> txn</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">offsets_size</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">memcpy</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">repData</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> reply</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token function" style="color:#d73a49">data</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> size</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> txn</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">offsets_size</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">binder_replace_objects</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">txn</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> repData</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> _pos</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">int</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">size</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">int</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">txn</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">data_size</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    txn</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">data</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ptr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">buffer </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> reinterpret_cast</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">uintptr_t</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">repData</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    txn</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">data_size </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> size</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>2、修正对象指针。</p>
<p>如果传入的参数包含Binder对象，如<code>register</code>方法的<code>Observe</code>。因此修复的数据可能导致偏移的地址前移或者后移，因此需要重新计算偏移，如：</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">replaceObjects</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">binder_txn_st </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">txn</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">uint8_t</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> objData</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">binder_size_t</span><span class="token plain"> _pos</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> _off</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">binder_size_t</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> offs </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> reinterpret_cast</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">binder_size_t</span><span class="token operator" style="color:#393A34">*</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">txn</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">data</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ptr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">offsets</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">unsigned</span><span class="token plain"> count </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> txn</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">offsets_size </span><span class="token operator" style="color:#393A34">/</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">sizeof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">binder_size_t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">while</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> count</span><span class="token operator" style="color:#393A34">--</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">memcmp</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">objData </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">int</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">offs</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">uint8_t</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">txn</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">data</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ptr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">buffer </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">int</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">offs</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">sizeof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">binder_size_t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">offs </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> _off</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">++</span><span class="token plain"> offs</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>3、内存释放。</p>
<p>需要保存原地址<code>A</code>和新的地址<code>AA</code>的映射关系到自定义的内存池中。</p>
<p>当<code>Binder</code>通信命令出现<code>BC_FREE_BUFFER</code>和<code>BR_FREE_BUFFER</code>时，则通过该命令要释放的<code>AA</code>地址，然后从内存池找到与之对应<code>A</code>的地址，并设置回去让上层继续释放，完成内存使用的闭环。</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> BC_FREE_BUFFER</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">uintptr_t</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> buffPtr </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">uintptr_t</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">cmd</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">uintptr_t</span><span class="token plain"> ptr </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> MemPool</span><span class="token operator" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">detach</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">buffPtr</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">__UNLIKELY</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> ptr</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">buffPtr </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ptr</span><span class="token punctuation" style="color:#393A34">;</span><span class="token comment" style="color:#999988;font-style:italic">// set origin buffer</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cmd </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">sizeof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">uintptr_t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token comment" style="color:#999988;font-style:italic">// move to next command</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">   </span><span class="token keyword" style="color:#00009f">break</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="附">附：<a href="https://www.iofomo.com/blog/Binder#%E9%99%84" class="hash-link" aria-label="附：的直接链接" title="附：的直接链接">​</a></h3>
<p>如果你有需要，可以直接使用我们已经封装好的<code>SDK</code>来实现相应的功能，该项目已经开源，链接地址如下：</p>
<p><a href="https://gitee.com/iofomo/binderceptor" target="_blank" rel="noopener noreferrer">Gitee</a></p>
<p><a href="https://github.com/iofomo/binderceptor" target="_blank" rel="noopener noreferrer">Github</a></p>]]></content:encoded>
            <category>Android</category>
            <category>Binder</category>
        </item>
        <item>
            <title><![CDATA[存储卡文件自动迁移方案]]></title>
            <link>https://www.iofomo.com/blog/COS</link>
            <guid>https://www.iofomo.com/blog/COS</guid>
            <pubDate>Fri, 01 Sep 2023 00:00:00 GMT</pubDate>
            <description><![CDATA[基于TF卡存储芯片和ExFAT文件系统，从固件底层的磁盘读写指令实现上层无感数据迁移。]]></description>
            <content:encoded><![CDATA[<blockquote>
<p>基于TF卡存储芯片和ExFAT文件系统，从固件底层的磁盘读写指令实现上层无感数据迁移。</p>
</blockquote>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="说明">说明<a href="https://www.iofomo.com/blog/COS#%E8%AF%B4%E6%98%8E" class="hash-link" aria-label="说明的直接链接" title="说明的直接链接">​</a></h3>
<h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="关键词">关键词<a href="https://www.iofomo.com/blog/COS#%E5%85%B3%E9%94%AE%E8%AF%8D" class="hash-link" aria-label="关键词的直接链接" title="关键词的直接链接">​</a></h5>
<p><code>COS：</code>即<code>Chip Operating System</code>，这里特指安全芯片内操作系统。</p>
<p><code>TF卡：</code>即外置存储卡，这里特指安全存储卡。</p>
<p><code>明区：</code>即TF卡的普通存储区域，普通数据区。</p>
<p><code>密区：</code>即TF卡的加密存储区域，安全数据区。</p>
<p><code>ExFAT：</code>即<code>Extended File Allocation Table File System</code>，扩展<code>FAT</code>，即扩展文件分配表；是<code>Microsoft</code>在<code>Windows</code>的<code>Embeded 5.0</code>以上中引入的一种适合于闪存的文件系统，为了解决<code>FAT32</code>等不支持<code>4G</code>及其更大的文件而推出。对于闪存，<code>NTFS</code>文件系统不适合使用，<code>ExFAT</code>更为适用。这里作为本方案的上层<code>TF卡</code>文件系统。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="背景">背景<a href="https://www.iofomo.com/blog/COS#%E8%83%8C%E6%99%AF" class="hash-link" aria-label="背景的直接链接" title="背景的直接链接">​</a></h3>
<p>当前场景对于安全<code>TF卡</code>核心需求为：</p>
<ol>
<li>简单易用，操作简单无需学习，开箱即用；现有方案安全数据的均需安全工具软件才能访问，不能满足多平台，体验参差不齐。</li>
<li>环境无痕，整个操作在系统中不留痕迹，无需安装软件或运行插件；当前安全数据访问需要安装或运行特定的软件或插件。</li>
</ol>
<p>在原安全<code>TF卡</code>技术方案上解决以上需求，即是本方案的目标。</p>
<p>关于简单易用性，操作系统提供了最为简单友好的文件管理软件，因此本方案的关键点就是直接利用操作系统的文件管理软件，无需进行软件或插件的开发，即可达到数据安全存储的目的。</p>
<p><img loading="lazy" src="https://www.iofomo.com/assets/images/1-0edd731d6fa970a796ee104e37fb664d.png" width="1318" height="664" class="img_ev3q"></p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="技术方案">技术方案<a href="https://www.iofomo.com/blog/COS#%E6%8A%80%E6%9C%AF%E6%96%B9%E6%A1%88" class="hash-link" aria-label="技术方案的直接链接" title="技术方案的直接链接">​</a></h3>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="设计">设计<a href="https://www.iofomo.com/blog/COS#%E8%AE%BE%E8%AE%A1" class="hash-link" aria-label="设计的直接链接" title="设计的直接链接">​</a></h4>
<p><img loading="lazy" src="https://www.iofomo.com/assets/images/2-a7ceda540cd95023ac26f3252e236996.png" width="599" height="588" class="img_ev3q"></p>
<p><code>说明：</code></p>
<ul>
<li>本方案解决了数据存储直接无需安装或运行软件或插件的问题。</li>
<li>在保存数据场景中直接使用操作系统的文件管理进行操作，简单易用，无痕。</li>
<li>在此场景下无需开发额外工具，只要操作系统文件管理可以访问标准的TF卡，即支持此安全功能。</li>
</ul>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="硬件">硬件<a href="https://www.iofomo.com/blog/COS#%E7%A1%AC%E4%BB%B6" class="hash-link" aria-label="硬件的直接链接" title="硬件的直接链接">​</a></h4>
<p>为了能够达到安全存储控制的目的，在传统的<code>TF卡</code>上增加安全芯片，其为<code>ARM</code>平台采用<code>SD指令</code>直接和<code>TF卡</code>进行通信，<code>TF卡</code>的数据加解密速度可达<code>25MB/S</code>以上。安全<code>TF卡</code>方案主要由：<code>SD</code>接口处理层、<code>Nandflash</code>管理层、<code>COS</code>、驱动四部分组成。其中<code>COS</code>主要包含：命令解析、数据识别、访问控制（授权认证）、加解密几个模块。</p>
<p><img loading="lazy" src="https://www.iofomo.com/assets/images/3-fde90fff2c5fab29b29aff5b43d7b1d4.png" width="1312" height="846" class="img_ev3q"></p>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="数据流">数据流<a href="https://www.iofomo.com/blog/COS#%E6%95%B0%E6%8D%AE%E6%B5%81" class="hash-link" aria-label="数据流的直接链接" title="数据流的直接链接">​</a></h4>
<p>当前主流方案为①至②的解决方案，密区的数据只能通过特定的接口进行访问。为了能够让密区的写命令也能借用普通命令通道，因此需要对写命令进行解析，并对目标数据进行重定向至密区。即方案升级为：②至③。</p>
<p><img loading="lazy" src="https://www.iofomo.com/assets/images/4-1c68a7b4f94e2a7fdc8a6899e94d6ee1.png" width="1349" height="361" class="img_ev3q"></p>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="数据存储">数据存储<a href="https://www.iofomo.com/blog/COS#%E6%95%B0%E6%8D%AE%E5%AD%98%E5%82%A8" class="hash-link" aria-label="数据存储的直接链接" title="数据存储的直接链接">​</a></h4>
<p>安全TF卡整个存储空间分布如下图所示：</p>
<p><img loading="lazy" src="https://www.iofomo.com/assets/images/5-f0ef005d9e767961a58b8476e02c995e.png" width="867" height="134" class="img_ev3q"></p>
<p>1）<code>MBR</code>，即<code>Master Boot Record</code>。存储分区格式通常为<code>MBR</code>分区和<code>GPT</code>（GUID Partition Table）分区两种格式。<code>MBR</code>磁盘分区支持最大卷为2 TB（Terabytes）并且每个磁盘最多有4个主分区（或3个主分区，1个扩展分区和无限制的逻辑驱动器），这里安全<code>TF卡</code>采用<code>MBR</code>分区格式。</p>
<p><img loading="lazy" src="https://www.iofomo.com/assets/images/6-5a4bb8697c56b258327393e1f755963a.png" width="597" height="513" class="img_ev3q"></p>
<p>2）<code>FAT</code>表，本方案只有一个，<code>FAT2</code>只有定义<code>TFAT</code>才存在，本方案不涉及。</p>
<p>3）簇位图，是<code>ExFAT</code>文件系统中的第一个元文件，类似于<code>NTFS</code>文件系统中的元文件<code>$BitMap</code>，它的作用是用来管理分区中簇的使用情况。簇位图文件中的每一个位，映射到数据区中的每一个簇。如果某个簇分配给了文件，该簇在簇位图文件中对应的位就会被填入<code>“1”</code>，表示该簇已经占用；如果没有使用的空簇，它们在簇位图文件中对应的位就是<code>“0”</code>。</p>
<p>4）大写字符，是<code>ExFAT</code>文件系统中的第二个元文件，类似于<code>NTFS</code>文件系统中的元文件<code>$UpCase</code>。<code>Unicode</code>字母表中的每一个字符在这个文件中都有对应的条目，用于比较、排序、计算<code>Hash</code>值。</p>
<p>5）用户数据，即<code>ExFAT</code>文件系统根目录数据，具有如下特征：</p>
<ul>
<li>分区中的每个文件及文件夹（也称为目录）都被分配多个大小为<code>32</code>字节的目录项，用以描述文件及文件夹的属性、大小、起始簇号和时间、日期等信息，当然还会把文件名或目录名也记录在目录项中。</li>
<li>目录也被视为特殊类型的文件，所以每个目录也与文件一样有目录项。</li>
<li>分区根目录下的文件及文件夹的目录项存放在根目录区中，分区子目录下的文件及文件夹的目录项存放在数据区相应的簇中。</li>
<li>文件系统目录项的第一个字节用来描述目录项的类型，剩下的<code>31</code>个字节用来记录文件的相关信息。</li>
</ul>
<p>6）隐藏区，属于加密区中的一部分，用于保存加密区数据的全局配置，如设备ID、认证ID、跟密钥也业务配置数据等。</p>
<p>7）密区用户数据，该数据按照自定义格式存储文件数据，格式为文件头和文件数据内容两部分。</p>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="解析和识别">解析和识别<a href="https://www.iofomo.com/blog/COS#%E8%A7%A3%E6%9E%90%E5%92%8C%E8%AF%86%E5%88%AB" class="hash-link" aria-label="解析和识别的直接链接" title="解析和识别的直接链接">​</a></h4>
<h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="sd命令接口扩展">SD命令接口扩展<a href="https://www.iofomo.com/blog/COS#sd%E5%91%BD%E4%BB%A4%E6%8E%A5%E5%8F%A3%E6%89%A9%E5%B1%95" class="hash-link" aria-label="SD命令接口扩展的直接链接" title="SD命令接口扩展的直接链接">​</a></h5>
<p>拦截SD接口标准数据写命令，并且可以扩展修改数据存储的扇区和数据内容，如接口定义如下：</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"> * @brief: 当用户在明区保存文件数据，ExFAT文件系统处理完成，落地明区磁盘之前的回调</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"> * @param lba 数据起始扇区号（可重定向）</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"> * @param buf 数据缓存地址，该数据修改后则会影响到实际落地的数据</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"> * @param blockNum 数据扇区数</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"> * @return</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"> *      0: 成功, 否则操作失败，中断返回</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"> * */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token class-name">uint8_t</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">tf_handleDataWrite</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">uint32_t</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> lba</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">uint8_t</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">buf</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">uint8_t</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> blockNum</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="exfat文件系统头识别">ExFAT文件系统头识别<a href="https://www.iofomo.com/blog/COS#exfat%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%A4%B4%E8%AF%86%E5%88%AB" class="hash-link" aria-label="ExFAT文件系统头识别的直接链接" title="ExFAT文件系统头识别的直接链接">​</a></h5>
<p>由于回调接口为底层磁盘扇区写操作接口，因此需要对传递过来的参数进行精准快速识别。需要在<code>COS</code>启动时对文件系统配置进行解析（如：簇大小，文件系统根目录偏移等）。因此首先需要了解<code>Main Boot Region</code> 主引导区<code>Boot Sector</code>（引导扇区）的数据结构。</p>
<table><thead><tr><th style="text-align:left">偏移量</th><th style="text-align:left">大小</th><th style="text-align:left">描述</th><th style="text-align:left">内容</th></tr></thead><tbody><tr><td style="text-align:left">0x00</td><td style="text-align:left">3</td><td style="text-align:left">跳转指令</td><td style="text-align:left">EB 76 90</td></tr><tr><td style="text-align:left">0x03</td><td style="text-align:left">8</td><td style="text-align:left">文件系统名称</td><td style="text-align:left">"EXFAT  "</td></tr><tr><td style="text-align:left">0x0B</td><td style="text-align:left">53</td><td style="text-align:left">保留区</td><td style="text-align:left">全为0</td></tr><tr><td style="text-align:left">0x40</td><td style="text-align:left">8</td><td style="text-align:left">隐藏扇区数</td><td style="text-align:left"></td></tr><tr><td style="text-align:left">0x48</td><td style="text-align:left">8</td><td style="text-align:left">分区总扇区数</td><td style="text-align:left"></td></tr><tr><td style="text-align:left">0x50</td><td style="text-align:left">4</td><td style="text-align:left">FAT表起始扇区号</td><td style="text-align:left"></td></tr><tr><td style="text-align:left">0x54</td><td style="text-align:left">4</td><td style="text-align:left">FAT表扇区数</td><td style="text-align:left"></td></tr><tr><td style="text-align:left">0x58</td><td style="text-align:left">4</td><td style="text-align:left">首簇起始扇区号</td><td style="text-align:left"></td></tr><tr><td style="text-align:left">0x5C</td><td style="text-align:left">4</td><td style="text-align:left">分区内的总簇数</td><td style="text-align:left">最大值为2^32-11</td></tr><tr><td style="text-align:left">0x60</td><td style="text-align:left">4</td><td style="text-align:left">根目录首簇号</td><td style="text-align:left">0x04只占1个簇</td></tr><tr><td style="text-align:left">0x64</td><td style="text-align:left">4</td><td style="text-align:left">卷序列号</td><td style="text-align:left">4个字节的随机数</td></tr><tr><td style="text-align:left">0x68</td><td style="text-align:left">2</td><td style="text-align:left">卷版本号</td><td style="text-align:left">固定为“00 01”</td></tr><tr><td style="text-align:left">0x6A</td><td style="text-align:left">2</td><td style="text-align:left">卷状态</td><td style="text-align:left">固定为“00 00”</td></tr><tr><td style="text-align:left">0x6C</td><td style="text-align:left">1</td><td style="text-align:left">每扇区字节数</td><td style="text-align:left">2^N(最小值为9à 2^9=512字节/扇区最大值为12à 2^12=4096字节/扇区)</td></tr><tr><td style="text-align:left">0x6D</td><td style="text-align:left">1</td><td style="text-align:left">每簇扇区数</td><td style="text-align:left">2^N(最小值为0à 2^0=1扇区/簇最大值为25à 2^16=65536扇区/簇 = 32 MB)</td></tr><tr><td style="text-align:left">0x6E</td><td style="text-align:left">1</td><td style="text-align:left">FAT表个数</td><td style="text-align:left">该值为1，只有对TExFAT才为2</td></tr><tr><td style="text-align:left">0x6F</td><td style="text-align:left">1</td><td style="text-align:left">驱动标记</td><td style="text-align:left">这个是提供给INT13中断使用的，通常为80H</td></tr><tr><td style="text-align:left">0x70</td><td style="text-align:left">1</td><td style="text-align:left">分区使用百分比</td><td style="text-align:left">0~100。百分之多少的簇已被分配。该值可不准确</td></tr><tr><td style="text-align:left">0x71</td><td style="text-align:left">7</td><td style="text-align:left">保留</td><td style="text-align:left">00</td></tr><tr><td style="text-align:left">0x78</td><td style="text-align:left">390</td><td style="text-align:left">引导程序</td><td style="text-align:left">固定值</td></tr><tr><td style="text-align:left">0x1FE</td><td style="text-align:left">2</td><td style="text-align:left">引导结束标志</td><td style="text-align:left">0x55AA</td></tr></tbody></table>
<p>说明：</p>
<ul>
<li>通过跳转指令和文件系统名称可以定位到文件系统的起始扇区号。</li>
<li>根据<code>0x6C</code>和<code>0x6D</code>可以获得每簇扇区数以及扇区字节数，用于文件数据内容扇区定位。</li>
</ul>
<h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="目标文件数据识别">目标文件数据识别<a href="https://www.iofomo.com/blog/COS#%E7%9B%AE%E6%A0%87%E6%96%87%E4%BB%B6%E6%95%B0%E6%8D%AE%E8%AF%86%E5%88%AB" class="hash-link" aria-label="目标文件数据识别的直接链接" title="目标文件数据识别的直接链接">​</a></h5>
<p>ExFAT文件系统中每个用户文件至少有三个目录项，这三个目录项被称为三个属性：第一个目录项称为“属性1”，目录项首字节的特征值为<code>“85H”</code>；第二个目录项称为“属性2”，目录项首字节的特征值为<code>“C0H”</code>；第三个目录项称为“属性3”，目录项首字节的特征值为<code>“C1H”</code>。</p>
<p><code>1）“属性1”目录项：</code></p>
<p>用来记录该目录项的附属目录项数、校验和、文件属性、时间戳等信息。其格式定义为：</p>
<table><thead><tr><th style="text-align:left">偏移</th><th style="text-align:left">字段长度(字节)</th><th style="text-align:left">说明</th></tr></thead><tbody><tr><td style="text-align:left">0x00</td><td style="text-align:left">1</td><td style="text-align:left">目录项的类型(特征值为“85H”)</td></tr><tr><td style="text-align:left">0x01</td><td style="text-align:left">1</td><td style="text-align:left">附属目录项数</td></tr><tr><td style="text-align:left">0x02</td><td style="text-align:left">2</td><td style="text-align:left">对所有属性项的Hash校验值</td></tr><tr><td style="text-align:left">0x04</td><td style="text-align:left">2</td><td style="text-align:left">文件属性</td></tr><tr><td style="text-align:left">0x06</td><td style="text-align:left">2</td><td style="text-align:left">保留</td></tr><tr><td style="text-align:left">0x08</td><td style="text-align:left">4</td><td style="text-align:left">文件创建时间</td></tr><tr><td style="text-align:left">0x0C</td><td style="text-align:left">4</td><td style="text-align:left">文件最后修改时间</td></tr><tr><td style="text-align:left">0x10</td><td style="text-align:left">4</td><td style="text-align:left">文件最后访问时间</td></tr><tr><td style="text-align:left">0x14</td><td style="text-align:left">1</td><td style="text-align:left">文件创建时间精确至10ms</td></tr><tr><td style="text-align:left">0x15</td><td style="text-align:left">1</td><td style="text-align:left">文件最后修改时间精确至10ms</td></tr><tr><td style="text-align:left">0x16</td><td style="text-align:left">1</td><td style="text-align:left">创建时间时区差，间隔15分钟</td></tr><tr><td style="text-align:left">0x17</td><td style="text-align:left">1</td><td style="text-align:left">最后修改时间时区差，间隔15分钟</td></tr><tr><td style="text-align:left">0x18</td><td style="text-align:left">1</td><td style="text-align:left">最后访问时间时区差，间隔15分钟</td></tr><tr><td style="text-align:left">0x19</td><td style="text-align:left">7</td><td style="text-align:left">保留</td></tr></tbody></table>
<p>该目录项可以识别目标文件的属性和起始目录项标识。</p>
<p><code>2）“属性2”目录项：</code></p>
<p>用来记录文件是否有碎片、文件名的字符数、文件名的Hash值、文件的起始簇号及大小等信息，格式定义如下：</p>
<table><thead><tr><th style="text-align:left">偏移</th><th style="text-align:left">字段长度(字节)</th><th style="text-align:left">说明</th></tr></thead><tbody><tr><td style="text-align:left">0x00</td><td style="text-align:left">1</td><td style="text-align:left">目录项的类型(特征值为“C0H”)</td></tr><tr><td style="text-align:left">0x01</td><td style="text-align:left">1</td><td style="text-align:left">文件碎片标志。如果是连续存放没有碎片，该标志为“03H”；如果是不连续存放，文件有碎片，该标志就为“01H”</td></tr><tr><td style="text-align:left">0x02</td><td style="text-align:left">1</td><td style="text-align:left">保留</td></tr><tr><td style="text-align:left">0x03</td><td style="text-align:left">1</td><td style="text-align:left">文件名字符数N。用UNICODE码表示，每个字符占用2个字节</td></tr><tr><td style="text-align:left">0x04</td><td style="text-align:left">2</td><td style="text-align:left">文件名Hash校验值。当文件名发生改变时，Hash值也会发生改变。</td></tr><tr><td style="text-align:left">0x06</td><td style="text-align:left">2</td><td style="text-align:left">保留</td></tr><tr><td style="text-align:left">0x08</td><td style="text-align:left">8</td><td style="text-align:left">文件大小1（文件的总字节数）</td></tr><tr><td style="text-align:left">0x10</td><td style="text-align:left">4</td><td style="text-align:left">保留</td></tr><tr><td style="text-align:left">0x14</td><td style="text-align:left">4</td><td style="text-align:left">起始簇号</td></tr><tr><td style="text-align:left">0x18</td><td style="text-align:left">8</td><td style="text-align:left">文件大小2（备份值）。通常情况下与“文件大小1”的数值保持一致</td></tr></tbody></table>
<p>通过属性2可以获取目标文件的大小和文件数据内容存储的起始簇号，通过起始簇号可以计算得到对应的扇区号，以及是否连续的特征。</p>
<p><code>3）“属性3”目录项：</code></p>
<p>用来具体记录文件的名称。如果文件名很长，“属性3”可以包含多个目录项，每个目录项称为一个片段，从上至下依次记录文件名的每一个字符。其格式定义为：</p>
<table><thead><tr><th style="text-align:left">偏移</th><th style="text-align:left">字段长度(字节)</th><th style="text-align:left">说明</th></tr></thead><tbody><tr><td style="text-align:left">0x00</td><td style="text-align:left">1</td><td style="text-align:left">目录项的类型(特征值为“C1H”)</td></tr><tr><td style="text-align:left">0x01</td><td style="text-align:left">1</td><td style="text-align:left">保留</td></tr><tr><td style="text-align:left">0x02</td><td style="text-align:left">2N</td><td style="text-align:left">文件名</td></tr></tbody></table>
<p>通过属性3可以获取文件名称。</p>
<h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="目标文件数据重定向">目标文件数据重定向<a href="https://www.iofomo.com/blog/COS#%E7%9B%AE%E6%A0%87%E6%96%87%E4%BB%B6%E6%95%B0%E6%8D%AE%E9%87%8D%E5%AE%9A%E5%90%91" class="hash-link" aria-label="目标文件数据重定向的直接链接" title="目标文件数据重定向的直接链接">​</a></h5>
<p>为了能够实现数据重定向，首先需要了解SD扩展接口的特性：</p>
<ul>
<li>底层接口每次传递数据大小为扇区整数倍。</li>
<li>接口调用流程不可改变，否则会导致中断信号异常，上层文件系统运行错误，出现数据损坏的情况。因此在回调实现中，只能修改目标扇区位置以及本次待写入的数据内容。</li>
<li>接口回调时若本次为连续扇区操作，则仅能在首次映射时进行重定向，后续的重定向将不能生效。
<img loading="lazy" src="https://www.iofomo.com/assets/images/7-a27a08cbaea7b880bc331fc0a8ed142c.png" width="628" height="335" class="img_ev3q"></li>
</ul>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="技术难点">技术难点<a href="https://www.iofomo.com/blog/COS#%E6%8A%80%E6%9C%AF%E9%9A%BE%E7%82%B9" class="hash-link" aria-label="技术难点的直接链接" title="技术难点的直接链接">​</a></h4>
<h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="sd命令接口扩展写">SD命令接口扩展（写）<a href="https://www.iofomo.com/blog/COS#sd%E5%91%BD%E4%BB%A4%E6%8E%A5%E5%8F%A3%E6%89%A9%E5%B1%95%E5%86%99" class="hash-link" aria-label="SD命令接口扩展（写）的直接链接" title="SD命令接口扩展（写）的直接链接">​</a></h5>
<p>该接口在底层固件实现，使得在接收到数据存储命令后，落地磁盘扇区前，回调给<code>COS</code>进行业务处理，这是整个方案能力基础。在<code>COS</code>处理完后，再将数据写入指定扇区位置。保证流程不中断，运行稳定。</p>
<h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="精准快速识别">精准快速识别<a href="https://www.iofomo.com/blog/COS#%E7%B2%BE%E5%87%86%E5%BF%AB%E9%80%9F%E8%AF%86%E5%88%AB" class="hash-link" aria-label="精准快速识别的直接链接" title="精准快速识别的直接链接">​</a></h5>
<p>由于文件系统数据存储高效率要求，若<code>COS</code>中数据处理耗时，则会直接触发超时，系统提前终止写入。因此对方案高效且精准的数据识别非常高。</p>
<ul>
<li>快速过滤非目标文件数据；在实际运行时，大量的磁盘读写操作与目标文件数据无关，因此需要快速返回，不影响正常使用。</li>
<li>文件头和文件内容区别识别；通常目标文件头需要精准识别，在识别完文件头后，文件内容数据则通过计算的簇链扇区号即可快速判断其合法扇区号。通常文件头格式固定，而文件内容长度则可变且长度大大超过文件头数据，因此仅通过扇区号合法性判断可以加快数据处理，提升效率。</li>
</ul>
<h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="扇区重定向">扇区重定向<a href="https://www.iofomo.com/blog/COS#%E6%89%87%E5%8C%BA%E9%87%8D%E5%AE%9A%E5%90%91" class="hash-link" aria-label="扇区重定向的直接链接" title="扇区重定向的直接链接">​</a></h5>
<p>重定向需要解决文件头数据不在同一扇区的问题，由于两次的回调给数据的识别和修复带来很大的麻烦。需要将两次扇区，即前一扇区的尾部和后一扇区的头部数据合并识别和修复。</p>
<p><img loading="lazy" src="https://www.iofomo.com/assets/images/8-db66dedaa60a394cc82fb00ec373e32d.png" width="500" height="207" class="img_ev3q"></p>
<p>为了使得上层的文件系统运行稳定，而文件头数据通常处于扇区的某个片段位置，因此回调后需要继续往明区写入数据。为了达到数据保护的目的，需要将原始文件真实数据保存至密区后，还需要对明区的数据进行伪装。</p>
<ul>
<li>伪装为其他文件名或文件夹</li>
<li>伪装为空文件名</li>
<li>伪装为已删除文件</li>
</ul>
<p>为了达到文件头数据格式正确需要对各属性项的数据进行<code>Hash</code>校验，其生成<code>Hash</code>的实现为：</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// 所有属性目录项的Hash值计算</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">unsigned</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">short</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">doEntrySetChecksumHash</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">unsigned</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">char</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> octets</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> NumberOfBytes</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">unsigned</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">short</span><span class="token plain"> checksum </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> index</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">index </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> index </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> NumberOfBytes</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> index</span><span class="token operator" style="color:#393A34">++</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">index </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">||</span><span class="token plain"> index </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">continue</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        checksum </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">checksum </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token number" style="color:#36acaa">15</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">checksum</span><span class="token operator" style="color:#393A34">&gt;&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">unsigned</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">short</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> octets</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">index</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> checksum</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">unsigned</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">char</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">toUpper</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">unsigned</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">char</span><span class="token plain"> ch</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token char">'a'</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;=</span><span class="token plain"> ch </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> ch </span><span class="token operator" style="color:#393A34">&lt;=</span><span class="token plain"> </span><span class="token char">'z'</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">?</span><span class="token plain"> ch </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">32</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> ch</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 属性2目录项中对属性3目录项中hash值计算</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">unsigned</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">short</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">doNameHash</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">uint8_t</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> name</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">uint8_t</span><span class="token plain"> nameLen</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> i</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">unsigned</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">short</span><span class="token plain"> hash </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> cc</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">i</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">nameLen</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i</span><span class="token operator" style="color:#393A34">++</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        cc </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">toUpper</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">name </span><span class="token operator" style="color:#393A34">++</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        hash </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">uint16_t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">hash </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">15</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">hash </span><span class="token operator" style="color:#393A34">&gt;&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">cc </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x00ff</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        hash </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">uint16_t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">hash </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">15</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">hash </span><span class="token operator" style="color:#393A34">&gt;&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">cc </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xff00</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> hash</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="文件头复写">文件头复写<a href="https://www.iofomo.com/blog/COS#%E6%96%87%E4%BB%B6%E5%A4%B4%E5%A4%8D%E5%86%99" class="hash-link" aria-label="文件头复写的直接链接" title="文件头复写的直接链接">​</a></h5>
<p>通常<code>ExFAT</code>文件系统会对文件头（文件目录属性项）进行多次复写。文件目录或空文件则无第四步骤。</p>
<ul>
<li>首次写入，则保存文件目录项格式（即属性1、属性2、属性3），不包含文件自身属性。</li>
<li>二次写入，则包含文件部分属性，如文件夹或文档，原文件修改时间，文件名。</li>
<li>三次写入，则包含本次文件创建时间，文件内容数据起始簇信息。</li>
<li>四次写入，则包含实际写入的数据大小即文件大小。</li>
</ul>
<p><img loading="lazy" src="https://www.iofomo.com/assets/images/9-b764e9dcb20c2dcc33f7b365454ea22c.png" width="617" height="322" class="img_ev3q"></p>
<p>因此在文件头解析过程中，需要对每次回调的数据进行解析和填充，确保加密的文件头数据正确无误。</p>
<h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="簇链追踪">簇链追踪<a href="https://www.iofomo.com/blog/COS#%E7%B0%87%E9%93%BE%E8%BF%BD%E8%B8%AA" class="hash-link" aria-label="簇链追踪的直接链接" title="簇链追踪的直接链接">​</a></h5>
<p>文件目录项记录了文件内容数据的起始簇号，数据以对应扇区号（连续或不连续）依次写入磁盘。</p>
<p><code>FAT</code>表区格式：</p>
<ul>
<li><code>ExFAT</code>的每个<code>FAT</code>项由4字节构成，也就是32位的表项。</li>
<li>每个<code>FAT</code>项都有一个固定的编号，这个编号从0开始，也就是说，第一个<code>FAT</code>项是0号<code>FAT</code>项，第二个FAT项是1号<code>FAT</code>项，以此类推。</li>
<li>每个<code>FAT</code>项占用4字节：其中0号<code>FAT</code>项描述介质类型，其首字节为“F8”，表示介质类型为硬盘；1号<code>FAT</code>项写入4个“FF”；从2号<code>FAT</code>项开始对应2号簇，3号<code>FAT</code>项开始对应3号簇，一直到最后一个簇。目前2、3、4三个<code>FAT</code>项中都是结束标志，簇位图文件、大写字符文件、根目录各占一个簇。</li>
<li>分区的数据区中的每一个簇都会映射到<code>FAT</code>表中的唯一一个<code>FAT</code>项。因为0号<code>FAT</code>项和1号<code>FAT</code>项有特殊的用途，无法与数据区中的簇形成映射，所以数据区中的第一个簇也就编号为2号簇，这也是没有0号簇和1号簇的原因，然后3号簇与3号<code>FAT</code>项映射，4号簇与4号<code>FAT</code>项映射，以此类推。</li>
<li>分区格式化后，分区的两个元文件（簇位图文件和大写字符文件）及用户文件都以簇为单位存放在数据区中，一个文件至少占用一个簇。当一个文件占用多个簇时，这些簇的簇号可能是连续的，也可能是不连续的。如果文件存放的簇不连续，这些簇的簇号就以簇链的形式登记在<code>FAT</code>表中；而如果文件存放在连续的簇中，<code>FAT</code>表则不登记这些连续的簇链。</li>
</ul>
<p>综上，<code>ExFAT</code>文件系统<code>FAT</code>表的功能主要是登记不连续存储的文件的簇链，所以在<code>FAT</code>中可以看到数值为0的<code>FAT</code>项，并不能说明该<code>FAT</code>项对应的簇是可用簇。</p>
<p>1）1.txt文件占0x05、0x07号簇，2.txt占0x06号簇，FAT表如下：
<img loading="lazy" src="data:image/png;base64,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" width="486" height="119" class="img_ev3q"></p>
<p>2）1.txt文件占0x05、0x07号簇，2.txt占0x06、0x0B、0x0C号簇，3.txt文件占0x08、0x0A号簇，4.txt占0x09号簇，FAT表如下：
<img loading="lazy" src="data:image/png;base64,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" width="485" height="113" class="img_ev3q"></p>
<p>因此，在识别文件内容数据时，需要从起始簇开始，对照<code>FAT</code>记录的非连续簇关系，动态生成判断扇区号是否为目标文件数据的合法性条件。</p>]]></content:encoded>
            <category>COS</category>
            <category>TF-Card</category>
        </item>
    </channel>
</rss>